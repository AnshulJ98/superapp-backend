name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-user-service:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "18"
      - name: Install dependencies
        run: npm install
        working-directory: services/user-service
      - name: Run tests
        run: npm test
        working-directory: services/user-service

  test-chat-service:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: "1.20"
      - name: Run tests
        run: go test -v ./...
        working-directory: services/chat-service
        env:
          # Tests expect redis to be reachable; use host.docker.internal on Docker Desktop,
          # or 'localhost' for native Linux/CI environments
          REDIS_ADDR: localhost:6379

  build-images:
    runs-on: ubuntu-latest
    needs: [test-user-service, test-chat-service]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - name: Build user-service image
        run: docker build -t superapp-user-service:latest services/user-service/
      - name: Build chat-service image
        run: docker build -t superapp-chat-service:latest services/chat-service/
      - name: Build analytics-service image
        run: docker build -t superapp-analytics-service:latest services/analytics-service/
      - name: Build gateway image
        run: docker build -t superapp-gateway:latest services/gateway/

  integration-test:
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - name: Start services
        run: docker compose up -d
      - name: Wait for services
        run: sleep 10
      - name: Check gateway health
        run: |
          curl -f http://localhost:8080/ || exit 1
      - name: Run API demo
        run: |
          cd clients/api
          npm install
          node demo.js
      - name: Cleanup
        if: always()
        run: docker compose down

  push-images:
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && github.repository_owner == 'AnshulJ98'
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - name: Check Docker Hub credentials
        id: check-credentials
        run: |
          if [[ -z "${{ secrets.DOCKER_USERNAME }}" ]] || [[ -z "${{ secrets.DOCKER_PASSWORD }}" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⚠️  Skipping Docker Hub push: DOCKER_USERNAME or DOCKER_PASSWORD not configured"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Login to Docker Hub
        if: steps.check-credentials.outputs.skip == 'false'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push user-service
        if: steps.check-credentials.outputs.skip == 'false'
        uses: docker/build-push-action@v4
        with:
          context: services/user-service/
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/superapp-user-service:latest
      - name: Build and push chat-service
        if: steps.check-credentials.outputs.skip == 'false'
        uses: docker/build-push-action@v4
        with:
          context: services/chat-service/
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/superapp-chat-service:latest
      - name: Build and push analytics-service
        if: steps.check-credentials.outputs.skip == 'false'
        uses: docker/build-push-action@v4
        with:
          context: services/analytics-service/
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/superapp-analytics-service:latest
      - name: Build and push gateway
        if: steps.check-credentials.outputs.skip == 'false'
        uses: docker/build-push-action@v4
        with:
          context: services/gateway/
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/superapp-gateway:latest
      - name: Note
        run: |
          echo "ℹ️  Docker Hub push is optional and requires DOCKER_USERNAME and DOCKER_PASSWORD secrets"
          echo "To enable: Set secrets in https://github.com/AnshulJ98/superapp-backend/settings/secrets/actions"
